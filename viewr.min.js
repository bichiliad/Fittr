/*! Viewr 2014-01-11 */
var Viewr=function(a,b,c){"use strict";if(!a)throw"You must provide a Flickr API key for Viewr to work.";var d=this;d.opts=b||{},d.key=a,d.fn=c||function(){},d.opts.filter=d.opts.filter||null,d.opts.increment="increment"in d.opts?d.opts.increment:!0,d.opts.incRatio=d.opts.incRatio||2,d.opts.square="square"in d.opts?d.opts.square:!1;var e="http://api.flickr.com/services/rest/?method=flickr.photos.getSizes&api_key="+d.key+"&format=json&nojsoncallback=1&photo_id=";d.images=[];var f=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.onreadystatechange=function(){4===c.readyState&&(200===c.status?b(JSON.parse(c.responseText)):(console.error(c),b(null,{status:c.status,statusText:c.statusText})))},c.send()};d.getImgsForID=function(a,b){f(e+a,b)},d.done=!1,d.reload=function(){d.done=!1;var a,c=1;if(a=d.opts.filter?document.querySelectorAll(d.opts.filter):document.getElementsByTagName("img"),0===a.length)return d.fn(),void 0;for(var e=[],f=a.length;f--;e.unshift(a[f]));e.forEach(function(e){var f=e.getAttribute("data-flickr-id"),g=e.tagName.toLowerCase();f&&"img"===g&&d.getImgsForID(f,function(g,h){h&&console.error("Failed to retrieve image: "+f,h);var i=new ViewrImage(e,g,b);i.init(),d.images.push(i),c++,c===a.length&&(d.done=!0,d.fn())})})},d.reload()},ViewrImage=function(a,b,c,d){var e=this;if(e.opts=c||{},!(a instanceof Element&&b&&b.sizes&&b.sizes.size instanceof Array))throw"Invalid ViewrImage: ensure elem and data are supplied";e.elem=a;var f,g,h=d||function(){},i=b.sizes.size,j=e.opts.square||!1,k=window.devicePixelRatio||1,l=e.opts.increment||!0,m=e.opts.incRatio||2;e.width=(a.width||a.style.width)*k,console.log("Width is",e.width),e.init=function(){console.log("Initializing image with width of",e.width);for(var b=0;b<i.length;b++)if(!(-1!==i[b].label.toLowerCase().indexOf("square")&&!j||-1===i[b].label.toLowerCase().indexOf("square")&&j)){if(f=i[b],f.width>=e.width)break;l&&!g&&f.width>=e.width/m&&(g=f,a.setAttribute("src",f.source))}l&&g?(a.onload=function(){a.setAttribute("src",f.source),a.onload=function(){h()}},a.onerror=function(){a.setAttribute("src",f.source),a.onerror=function(){h(),a.onerror=null}},a.setAttribute("src",g.source)):a.setAttribute("src",f.source),a.style.visibility="visible"}};