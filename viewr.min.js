/*! Viewr 2014-01-07 */
var Viewr=function(a,b,c){"use strict";if(!a)throw"You must provide a Flickr API key for Viewr to work.";var d=this;d.opts=b||{},d.key=a,d.fn=c||function(){},d.opts.filter=d.opts.filter||null,d.opts.increment="increment"in d.opts?d.opts.increment:!0,d.opts.incRatio=d.opts.incRatio||2,d.opts.square="square"in d.opts?d.opts.square:!1;var e="http://api.flickr.com/services/rest/?method=flickr.photos.getSizes&api_key="+d.key+"&format=json&nojsoncallback=1&photo_id=";d.images=[];var f=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.onreadystatechange=function(){4===c.readyState&&(200===c.status?b(JSON.parse(c.responseText)):(console.error(c),b(null,{status:c.status,statusText:c.statusText})))},c.send()};d.getImgsForID=function(a,b){f(e+a,b)},d.done=!1,d.reload=function(){d.done=!1;var a,c=1;if(a=d.opts.filter?document.querySelectorAll(d.opts.filter):document.getElementsByTagName("img"),0===a.length)return d.fn(),void 0;for(var e=[],f=a.length;f--;e.unshift(a[f]));e.forEach(function(e){var f=e.getAttribute("data-flickr-id"),g=e.tagName.toLowerCase();f&&"img"===g&&d.getImgsForID(f,function(g,h){h&&console.error("Failed to retrieve image: "+f,h);var i=new ViewrImage(e,g,b);i.init(),d.images.push(i),c++,c===a.length&&(d.done=!0,d.fn())})})},d.reload()},ViewrImage=function(a,b,c){var d=this;if(d.opts=c||{},!(a instanceof Element&&b&&b.sizes&&b.sizes.size instanceof Array))throw"Invalid ViewrImage: ensure elem and data are supplied";var e,f,g=b.sizes.size,h=d.opts.square||!1,i=window.devicePixelRatio||1,j=d.opts.increment||!0,k=d.opts.incRatio||2;d.width=(a.width||a.style.width)*i,d.init=function(){console.log("Initializing image with width of",d.width);for(var b=0;b<g.length;b++)if(!(-1!==g[b].label.toLowerCase().indexOf("square")&&!h||-1===g[b].label.toLowerCase().indexOf("square")&&h)){if(e=g[b],e.width>=d.width)break;j&&!f&&e.width>=d.width/k&&(f=e,a.setAttribute("src",e.source))}j&&f?(a.onload=function(){a.setAttribute("src",e.source)},a.setAttribute("src",f.source)):a.setAttribute("src",e.source),a.style.visibility="visible"}};